name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: npm install

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'AxeOS Live! ${{ github.ref_name }}'
          releaseBody: |
            ## What's New in v1.5.0

            ### Hashrate Benchmark Tool
            A powerful new tool to automatically find the optimal voltage and frequency settings for your miners!

            #### Features
            - **Quick Benchmark** - Test stability of current settings (~10 minutes)
            - **Full Optimization** - Automated search for maximum hashrate (30+ minutes)
            - **Efficiency Mode** - Find the most efficient J/TH settings
            - **Live Progress** - Real-time display of hashrate, temperature, and power during testing
            - **Results Table** - Top 5 performers by hashrate and efficiency
            - **Auto-Apply** - Automatically applies the best settings found

            #### Safety Features
            - Temperature limits (66°C chip, 86°C VR)
            - Power limit (40W for DC plug safety)
            - Input voltage monitoring (4.8V - 5.5V)
            - 90-second stabilization between tests
            - Graceful stop with best settings applied

            #### How It Works
            1. Go to **Tools > Hashrate Benchmark Tool**
            2. Select a miner and benchmark mode
            3. Set starting voltage/frequency (or use current settings)
            4. Click **Start Benchmark**
            5. The tool will systematically test combinations and find optimal settings

            Based on the popular [Bitaxe-Hashrate-Benchmark](https://github.com/ShaeOJ/Bitaxe-Hashrate-Benchmark) Python tool, now built directly into the app!

            ---

            **Full Changelog**: https://github.com/ShaeOJ/Axe-OS-Multitool/compare/v1.4.0...v1.5.0
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}
          includeUpdaterJson: false
